# Arnold - Discord Task Bot

Arnold is a Discord bot that manages development tasks and executes them using Claude Code.

## Architecture

```
User (Discord) → Arnold (orchestrator) → Claude Code (executor)
                      ↓                         ↓
                  Supabase                  GitHub
                (tasks + logs)            (code changes)
```

### Components

1. **Bot (src/bot.ts)**: Discord message handler, routes to agent
2. **Agent (src/agent.ts)**: Multi-turn Claude conversation for parsing user intent
3. **Executor (src/executor.ts)**: Polls for tasks, spawns Claude Code to execute them
4. **Tools (src/tools/)**: Actions the agent can take (create_task, search_tasks, etc.)

## Database Tables

### `dev_tasks`
- Task queue with status workflow: backlog → todo → in_progress → done/stuck
- Stores execution details (cost, tokens, duration) from Claude Code

### `system_logs`
- All Arnold logs go here with `source_type: 'dev_agent'`
- Each instance has unique `source_id` for tracing
- Logs are associated with `task_id` during task execution

## Logging System

**All logging goes through `src/logger.ts`:**
```typescript
import { logger } from './logger.js';

logger.info('Message', { key: 'value' });
logger.error('Failed', error);
logger.warn('Warning');
logger.debug('Debug info');  // Only in dev mode
```

**Logs are written to:**
1. Console (always) - pretty in dev, JSON in prod
2. Supabase `system_logs` table (INFO+ always, DEBUG only in dev)

**Task context:**
```typescript
import { setLogTaskContext } from './logger.js';
setLogTaskContext(taskId);  // Associate logs with a task
setLogTaskContext(null);    // Clear context
```

**Query logs:**
```bash
npm run logs                    # Recent 50 logs
npm run logs -- -e              # Errors only
npm run logs -- -t <task-id>    # Logs for a task
npm run logs -- -s 1h -f        # Follow last hour
npm run logs -- --help          # All options
```

## Claude Code Integration

When executing tasks, Arnold:
1. Spawns Claude Code with the task prompt
2. Passes environment variables: `ANTHROPIC_API_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `GITHUB_API_KEY`
3. Claude Code handles: git pull, implement changes, commit, push
4. Arnold parses output markers: `DEV_NOTES_START/END`, `TASK_FLAGGED`, `COMMIT_HASH_START/END`
5. Arnold verifies the commit exists on remote

## Safety

- Tasks are assessed for potential harm before execution
- Flagged tasks are marked as "stuck" and not executed
- All secrets are redacted from logs via `redactSecrets()` in executor.ts

## Key Files

- `src/executor.ts` - Task execution, Claude Code spawning
- `src/agent.ts` - User intent parsing with tool use
- `src/supabase.ts` - Database operations
- `src/logger.ts` - Unified logging to console + Supabase
- `src/logs-cli.ts` - CLI for viewing logs

## Environment Variables

Required:
- `DISCORD_TOKEN`
- `ANTHROPIC_API_KEY`
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `GITHUB_API_KEY`

Optional:
- `DISCORD_USER_ID` - Restrict to single user
- `GROQ_API_KEY` - Voice transcription
- `WORKSPACE_DIR` - Where to clone repos (default: /tmp/workspace)
- `GITHUB_REPO_OWNER`, `GITHUB_REPO_NAME`, `GITHUB_REPO_BRANCH`
